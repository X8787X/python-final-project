import tkinter as tk
from tkinter import simpledialog, messagebox
import random, json, os

# -------------------------------
# æ’²å…‹ç‰Œè³‡æ–™
# -------------------------------
unicode_cards = {
    "â™ ": {1:"ğŸ‚¡",2:"ğŸ‚¢",3:"ğŸ‚£",4:"ğŸ‚¤",5:"ğŸ‚¥",6:"ğŸ‚¦",7:"ğŸ‚§",8:"ğŸ‚¨",9:"ğŸ‚©",10:"ğŸ‚ª",11:"ğŸ‚«",12:"ğŸ‚­",13:"ğŸ‚®"},
    "â™¥": {1:"ğŸ‚±",2:"ğŸ‚²",3:"ğŸ‚³",4:"ğŸ‚´",5:"ğŸ‚µ",6:"ğŸ‚¶",7:"ğŸ‚·",8:"ğŸ‚¸",9:"ğŸ‚¹",10:"ğŸ‚º",11:"ğŸ‚»",12:"ğŸ‚½",13:"ğŸ‚¾"},
    "â™¦": {1:"ğŸƒ",2:"ğŸƒ‚",3:"ğŸƒƒ",4:"ğŸƒ„",5:"ğŸƒ…",6:"ğŸƒ†",7:"ğŸƒ‡",8:"ğŸƒˆ",9:"ğŸƒ‰",10:"ğŸƒŠ",11:"ğŸƒ‹",12:"ğŸƒ",13:"ğŸƒ"},
    "â™£": {1:"ğŸƒ‘",2:"ğŸƒ’",3:"ğŸƒ“",4:"ğŸƒ”",5:"ğŸƒ•",6:"ğŸƒ–",7:"ğŸƒ—",8:"ğŸƒ˜",9:"ğŸƒ™",10:"ğŸƒš",11:"ğŸƒ›",12:"ğŸƒ",13:"ğŸƒ"}
}
suits=["â™ ","â™¥","â™¦","â™£"]
card_back="ğŸ‚ "

HISTORY_FILE = "game_history.txt"

# -------------------------------
# ç‰Œçµ„
# -------------------------------
def create_deck():
    deck=[]
    for s in suits:
        for r in range(1,14):
            value = 11 if r==1 else 10 if r>=11 else r
            deck.append({"suit":s,"rank":r,"value":value,"symbol":unicode_cards[s][r]})
    random.shuffle(deck)
    return deck

# -------------------------------
# ç©å®¶ class
# -------------------------------
class Player:
    def __init__(self,name):
        self.name=name
        self.chips=1000
        self.cards=[]
        self.bet=0
        self.score=0
        self.result=""

# -------------------------------
# è¨ˆç®—åˆ†æ•¸
# -------------------------------
def calculate_score(cards):
    values=[c["value"] for c in cards]
    if sum(values)==21 and len(values)==2:
        return 0
    while 11 in values and sum(values)>21:
        for c in cards:
            if c["value"]==11:
                c["value"]=1
                break
        values=[c["value"] for c in cards]
    return sum(values)

def compare(u,d):
    if u==d:
        return "å¹³æ‰‹"
    elif d==0:
        return "èŠå®¶å‹"
    elif u==0:
        return "ç©å®¶å‹"
    elif u>21:
        return "ç©å®¶çˆ†ç‰Œï¼ŒèŠå®¶å‹"
    elif d>21:
        return "èŠå®¶çˆ†ç‰Œï¼Œç©å®¶å‹"
    elif u>d:
        return "ç©å®¶å‹"
    else:
        return "èŠå®¶å‹"

def format_cards(cards, hide_second=False):
    syms=[]
    for i,c in enumerate(cards):
        if hide_second and i>=1:
            syms.append(card_back)
        else:
            syms.append(c["symbol"])
    return " ".join(syms)

# -------------------------------
# å­˜å–æ­·å²ç´€éŒ„
# -------------------------------
def save_game_history(record):
    history = load_game_history()
    history.append(record)
    with open(HISTORY_FILE,"w",encoding="utf-8") as f:
        json.dump(history,f,ensure_ascii=False, indent=2)

def load_game_history():
    if not os.path.exists(HISTORY_FILE):
        with open(HISTORY_FILE,"w",encoding="utf-8") as f:
            json.dump([],f)
        return []
    with open(HISTORY_FILE,"r",encoding="utf-8") as f:
        return json.load(f)

# -------------------------------
# GUI
# -------------------------------
class BlackjackGUI:
    def __init__(self):
        self.deck=create_deck()
        self.players=[]
        self.current_player_idx=0
        self.dealer={"name":"èŠå®¶","cards":[],"score":0}
        self.root=tk.Tk()
        self.root.title("Blackjack 21 é»")
        
        # é¡¯ç¤ºè³‡è¨Š
        self.info=tk.Label(self.root,text="",font=("Arial",14))
        self.info.pack()
        
        # Button
        self.btn_hit=tk.Button(self.root,text="è£œç‰Œ",command=self.hit)
        self.btn_hit.pack()
        self.btn_stand=tk.Button(self.root,text="åœç‰Œ",command=self.stand)
        self.btn_stand.pack()
        self.btn_start=tk.Button(self.root,text="é–‹å§‹éŠæˆ²",command=self.start_game)
        self.btn_start.pack()
        self.btn_history=tk.Button(self.root,text="æ­·å²ç´€éŒ„",command=self.show_history)
        self.btn_history.pack()
        self.btn_exit=tk.Button(self.root,text="çµæŸéŠæˆ²",command=self.exit_game)
        self.btn_exit.pack()
        
        self.start_game()
        self.root.mainloop()

    def start_game(self):
        self.players=[]
        n=int(simpledialog.askinteger("ç©å®¶äººæ•¸","è«‹è¼¸å…¥ç©å®¶äººæ•¸",minvalue=1,maxvalue=4))
        for i in range(n):
            name=simpledialog.askstring("ç©å®¶åç¨±",f"è¼¸å…¥ç©å®¶{i+1}åç¨±")
            self.players.append(Player(name))
        self.current_player_idx=0
        self.next_player()

    def next_player(self):
        if self.current_player_idx>=len(self.players):
            self.dealer_play()
            self.show_results()
            return
        self.player=self.players[self.current_player_idx]
        self.player.cards=[]
        self.player.score=0
        self.player.bet=simpledialog.askinteger("ä¸‹æ³¨é‡‘é¡",f"{self.player.name} ç±Œç¢¼:{self.player.chips} ä¸‹æ³¨:",minvalue=1,maxvalue=self.player.chips)
        self.deal_to_player(self.player)
        self.update_display()

    def deal_to_player(self,p):
        if len(self.deck)<2:
            self.deck=create_deck()
        p.cards.append(self.deck.pop())
        p.cards.append(self.deck.pop())
        p.score=calculate_score(p.cards)

    def hit(self):
        if len(self.deck)==0:
            self.deck=create_deck()
        self.player.cards.append(self.deck.pop())
        self.player.score=calculate_score(self.player.cards)
        self.update_display()
        if self.player.score>21:
            self.current_player_idx+=1
            self.next_player()

    def stand(self):
        self.current_player_idx+=1
        self.next_player()

    def dealer_play(self):
        self.dealer["cards"]=[]
        self.dealer["cards"].append(self.deck.pop())
        self.dealer["cards"].append(self.deck.pop())
        self.dealer["score"]=calculate_score(self.dealer["cards"])
        while self.dealer["score"]<17 and self.dealer["score"]!=0:
            self.dealer["cards"].append(self.deck.pop())
            self.dealer["score"]=calculate_score(self.dealer["cards"])

    def show_results(self):
        msg="=== èŠå®¶çµæœ ===\n"
        msg+=f"èŠå®¶ç‰Œ: {format_cards(self.dealer['cards'])}, åˆ†æ•¸:{self.dealer['score']}\n\n"
        for p in self.players:
            p.result=compare(p.score,self.dealer["score"])
            if "ç©å®¶å‹" in p.result:
                p.chips+=p.bet
            elif "èŠå®¶å‹" in p.result:
                p.chips-=p.bet
            msg+=f"{p.name}: {format_cards(p.cards)}, åˆ†æ•¸:{p.score}, çµæœ:{p.result}, ç±Œç¢¼:{p.chips}\n"
            # å­˜æ­·å²
            save_game_history({
                "player":p.name,
                "user_cards":[{"suit":c["suit"],"rank":c["rank"]} for c in p.cards],
                "dealer_cards":[{"suit":c["suit"],"rank":c["rank"]} for c in self.dealer["cards"]],
                "user_score":p.score,
                "dealer_score":self.dealer["score"],
                "result":p.result,
                "chips_after":p.chips
            })
        messagebox.showinfo("éŠæˆ²çµæœ",msg)

    def update_display(self):
        self.info.config(text=f"{self.player.name} ç‰Œ: {format_cards(self.player.cards)}, åˆ†æ•¸:{self.player.score}")

    def show_history(self):
        history=load_game_history()
        if not history:
            messagebox.showinfo("æ­·å²ç´€éŒ„","ç›®å‰ç„¡æ­·å²ç´€éŒ„")
            return
        msg="=== æ­·å²ç´€éŒ„ ===\n"
        for h in history:
            uc = " ".join([unicode_cards[c["suit"]][c["rank"]] for c in h["user_cards"]])
            dc = " ".join([unicode_cards[c["suit"]][c["rank"]] for c in h["dealer_cards"]])
            msg+=f"{h['player']}: {uc} ({h['user_score']}åˆ†) vs èŠå®¶ {dc} ({h['dealer_score']}åˆ†) => {h['result']}, ç±Œç¢¼:{h['chips_after']}\n"
        messagebox.showinfo("æ­·å²ç´€éŒ„",msg)

    def exit_game(self):
        history=load_game_history()
        msg="=== ç¸½çµ ===\n"
        players=set(h["player"] for h in history)
        for p in players:
            total=sum(1 for h in history if h["player"]==p)
            wins=sum(1 for h in history if h["player"]==p and "ç©å®¶å‹" in h["result"])
            chips=max(h["chips_after"] for h in history if h["player"]==p)
            win_rate=wins/total*100 if total>0 else 0
            msg+=f"{p}: ç¸½å±€æ•¸:{total}, å‹ç‡:{win_rate:.2f}%, ç±Œç¢¼:{chips}\n"
        messagebox.showinfo("éŠæˆ²ç¸½çµ",msg)
        self.root.destroy()

# -------------------------------
# å•Ÿå‹•éŠæˆ²
# -------------------------------
BlackjackGUI()
