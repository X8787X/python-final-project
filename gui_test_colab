# å®‰è£ ipywidgetsï¼ˆColab å¯èƒ½å·²å®‰è£ï¼‰
!pip install ipywidgets -q

import random, json
from IPython.display import display, clear_output
import ipywidgets as widgets

# -------------------------------
# æ’²å…‹ç‰Œè³‡æ–™
# -------------------------------
unicode_cards = {
    "â™ ": {1:"ğŸ‚¡", 2:"ğŸ‚¢", 3:"ğŸ‚£", 4:"ğŸ‚¤", 5:"ğŸ‚¥", 6:"ğŸ‚¦", 7:"ğŸ‚§", 8:"ğŸ‚¨", 9:"ğŸ‚©", 10:"ğŸ‚ª", 11:"ğŸ‚«", 12:"ğŸ‚­", 13:"ğŸ‚®"},
    "â™¥": {1:"ğŸ‚±", 2:"ğŸ‚²", 3:"ğŸ‚³", 4:"ğŸ‚´", 5:"ğŸ‚µ", 6:"ğŸ‚¶", 7:"ğŸ‚·", 8:"ğŸ‚¸", 9:"ğŸ‚¹", 10:"ğŸ‚º", 11:"ğŸ‚»", 12:"ğŸ‚½", 13:"ğŸ‚¾"},
    "â™¦": {1:"ğŸƒ", 2:"ğŸƒ‚", 3:"ğŸƒƒ", 4:"ğŸƒ„", 5:"ğŸƒ…", 6:"ğŸƒ†", 7:"ğŸƒ‡", 8:"ğŸƒˆ", 9:"ğŸƒ‰", 10:"ğŸƒŠ", 11:"ğŸƒ‹", 12:"ğŸƒ", 13:"ğŸƒ"},
    "â™£": {1:"ğŸƒ‘", 2:"ğŸƒ’", 3:"ğŸƒ“", 4:"ğŸƒ”", 5:"ğŸƒ•", 6:"ğŸƒ–", 7:"ğŸƒ—", 8:"ğŸƒ˜", 9:"ğŸƒ™", 10:"ğŸƒš", 11:"ğŸƒ›", 12:"ğŸƒ", 13:"ğŸƒ"}
}
suits = ["â™ ","â™¥","â™¦","â™£"]
card_back = "ğŸ‚ "

# -------------------------------
# ç‰Œçµ„ & æ´—ç‰Œ
# -------------------------------
def create_deck():
    deck = []
    for s in suits:
        for r in range(1,14):
            value = 11 if r==1 else 10 if r>=11 else r
            deck.append({"suit":s, "rank":r, "value":value, "symbol":unicode_cards[s][r]})
    random.shuffle(deck)
    return deck

# -------------------------------
# è¨ˆç®—åˆ†æ•¸
# -------------------------------
def calculate_score(cards):
    values = [c["value"] for c in cards]
    if sum(values)==21 and len(values)==2:
        return 0
    while 11 in values and sum(values)>21:
        for c in cards:
            if c["value"]==11:
                c["value"]=1
                break
        values = [c["value"] for c in cards]
    return sum(values)

# -------------------------------
# æ¯”è¼ƒçµæœ
# -------------------------------
def compare(u,d):
    if u==d:
        return "å¹³æ‰‹"
    elif d==0:
        return "èŠå®¶å‹"
    elif u==0:
        return "ç©å®¶å‹"
    elif u>21:
        return "ç©å®¶çˆ†ç‰Œï¼ŒèŠå®¶å‹"
    elif d>21:
        return "èŠå®¶çˆ†ç‰Œï¼Œç©å®¶å‹"
    elif u>d:
        return "ç©å®¶å‹"
    else:
        return "èŠå®¶å‹"

# -------------------------------
# æ ¼å¼åŒ–é¡¯ç¤º
# -------------------------------
def format_cards(cards, hide_second=False):
    syms=[]
    nums=[]
    for i,c in enumerate(cards):
        if hide_second and i>=1:
            syms.append(card_back)
            nums.append("?")
        else:
            syms.append(c["symbol"])
            nums.append(f'{c["suit"]}{c["value"]}')
    return f"{' '.join(syms)}  [{', '.join(nums)}]"

# -------------------------------
# ç©å®¶ class
# -------------------------------
class Player:
    def __init__(self,name):
        self.name=name
        self.chips=1000
        self.cards=[]
        self.bet=0
        self.score=0
        self.result=""

# -------------------------------
# å…¨å±€è®Šæ•¸
# -------------------------------
deck=create_deck()
players=[]
dealer={"name":"èŠå®¶","cards":[],"score":0}
current_player_idx=0
game_over=False
history=[]

# -------------------------------
# Widget
# -------------------------------
out = widgets.Output()
btn_hit = widgets.Button(description="è£œç‰Œ")
btn_stand = widgets.Button(description="åœç‰Œ")
btn_start = widgets.Button(description="é–‹å§‹éŠæˆ²")
btn_exit = widgets.Button(description="çµæŸéŠæˆ²")

# -------------------------------
# éŠæˆ²å‡½æ•¸
# -------------------------------
def deal_to_player(p):
    global deck
    if len(deck)<2:
        deck=create_deck()
    p.cards.append(deck.pop())
    p.cards.append(deck.pop())
    p.score=calculate_score(p.cards)

def hit_player(p):
    global deck
    if len(deck)==0:
        deck=create_deck()
    p.cards.append(deck.pop())
    p.score=calculate_score(p.cards)

def dealer_play():
    global deck
    dealer.score=calculate_score(dealer["cards"])
    while dealer.score!=0 and dealer.score<17:
        if len(deck)==0:
            deck=create_deck()
        dealer["cards"].append(deck.pop())
        dealer.score=calculate_score(dealer["cards"])

def check_result(p):
    p.result=compare(p.score,dealer["score"])
    if "ç©å®¶å‹" in p.result:
        p.chips+=p.bet
    elif "èŠå®¶å‹" in p.result:
        p.chips-=p.bet

def update_display():
    with out:
        clear_output()
        p=players[current_player_idx]
        print(f"=== {p.name} çš„å›åˆ ===")
        print(f"ç±Œç¢¼: {p.chips}  ä¸‹æ³¨: {p.bet}")
        print(f"ä½ çš„ç‰Œ: {format_cards(p.cards)}, åˆ†æ•¸: {p.score}")
        print(f"èŠå®¶çš„ç‰Œ: {format_cards(dealer['cards'], hide_second=True)}")

# -------------------------------
# å›åˆæ§åˆ¶
# -------------------------------
def start_turn(b):
    global current_player_idx, game_over, players
    with out:
        clear_output()
        n=int(input("è«‹è¼¸å…¥ç©å®¶äººæ•¸:"))
        players=[]
        for i in range(n):
            name=input(f"è¼¸å…¥ç©å®¶{i+1}åç¨±:")
            players.append(Player(name))
        print("æ‰€æœ‰ç©å®¶åˆå§‹åŒ–å®Œæˆï¼Œæ¯ä½ç©å®¶1000ç±Œç¢¼ã€‚")
        current_player_idx=0
        next_player()

def next_player(b=None):
    global current_player_idx
    if current_player_idx>=len(players):
        dealer["cards"]=[]
        for _ in range(2):
            dealer["cards"].append(deck.pop())
        dealer_play()
        # é¡¯ç¤ºæ‰€æœ‰ç©å®¶çµæœ
        with out:
            clear_output()
            print("=== èŠå®¶çµæœ ===")
            print(f"èŠå®¶çš„ç‰Œ: {format_cards(dealer['cards'])}, åˆ†æ•¸: {dealer['score']}")
            print("\n=== ç©å®¶çµæœ ===")
            for p in players:
                check_result(p)
                print(f"{p.name}ï¼š{format_cards(p.cards)}, åˆ†æ•¸: {p.score}, çµæœ: {p.result}, ç±Œç¢¼: {p.chips}")
                history.append({
                    "player":p.name,
                    "user_cards":p.cards,
                    "dealer_cards":dealer["cards"],
                    "user_score":p.score,
                    "dealer_score":dealer["score"],
                    "result":p.result,
                    "chips_after":p.chips
                })
        print("\néŠæˆ²çµæŸã€‚å¯æŒ‰ã€Œé–‹å§‹éŠæˆ²ã€é–‹å§‹æ–°å±€ï¼Œæˆ–æŒ‰ã€ŒçµæŸéŠæˆ²ã€æŸ¥çœ‹ç¸½å‹ç‡ã€‚")
        return
    # é€²å…¥ä¸‹ä¸€ç©å®¶
    p=players[current_player_idx]
    p.cards=[]
    p.score=0
    p.bet=0
    with out:
        clear_output()
        while True:
            try:
                b=int(input(f"{p.name} ä¸‹æ³¨é‡‘é¡(ç±Œç¢¼:{p.chips}):"))
                if b>0 and b<=p.chips:
                    p.bet=b
                    break
                else:
                    print("ä¸‹æ³¨é‡‘é¡ä¸åˆæ³•")
            except:
                print("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—")
    deal_to_player(p)
    update_display()

def btn_hit_click(b):
    p=players[current_player_idx]
    hit_player(p)
    update_display()
    if p.score>21:
        global current_player_idx
        current_player_idx+=1
        next_player()

def btn_stand_click(b):
    global current_player_idx
    current_player_idx+=1
    next_player()

def exit_game(b):
    with out:
        clear_output()
        print("=== éŠæˆ²ç¸½çµ ===")
        for p in players:
            total_games = sum(1 for h in history if h["player"]==p.name)
            wins = sum(1 for h in history if h["player"]==p.name and "ç©å®¶å‹" in h["result"])
            win_rate = wins/total_games*100 if total_games>0 else 0
            print(f"{p.name} ç¸½å±€æ•¸: {total_games}, å‹ç‡: {win_rate:.2f}%, ç±Œç¢¼: {p.chips}")
        print("\næ„Ÿè¬éŠç©ï¼")

# -------------------------------
# Button äº‹ä»¶ç¶å®š
# -------------------------------
btn_hit.on_click(btn_hit_click)
btn_stand.on_click(btn_stand_click)
btn_start.on_click(start_turn)
btn_exit.on_click(exit_game)

display(btn_start, btn_hit, btn_stand, btn_exit, out)
